name: Deploy SkillSwap API to Koyeb ðŸš€
# This workflow is triggered when the build workflow completes successfully
on:
  # AppelÃ© par d'autres workflows.
  workflow_call:

  # Manual trigger for testing
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install Koyeb CLI and Deploy to Koyeb ðŸš€ðŸš€
        env:
          # Get the Koyeb API token from GitHub secrets
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
          # Organization IDs from secrets
          KOYEB_BACK_ORG_ID: ${{ secrets.KOYEB_BACK_ORG_ID }}
          KOYEB_FRONT_ORG_ID: ${{ secrets.KOYEB_FRONT_ORG_ID }}
        run: |
          # Download and install the Koyeb CLI
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sh
          
          # Add the Koyeb CLI to the PATH for this shell session
          export PATH=$HOME/.koyeb/bin:$PATH
          
          # Create the Koyeb configuration directory and file
          mkdir -p $HOME/.koyeb
          touch $HOME/.koyeb.yaml
          
          # Deploy the backend service in skillswap-back-bdd organization
          echo "ðŸš€ Deploying backend service..."
          koyeb service redeploy back/skillswap-api --organization $KOYEB_BACK_ORG_ID
          
          # Deploy the frontend service in skillswap-front organization
          echo "ðŸš€ Deploying frontend service..."
          koyeb service redeploy front/skillswap-frontend --organization $KOYEB_FRONT_ORG_ID
          
          echo "âœ… Both services deployed successfully!"