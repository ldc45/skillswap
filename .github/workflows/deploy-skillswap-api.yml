name: Deploy SkillSwap API to Koyeb (Safe Switch) ğŸš€
on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install Koyeb CLI and Deploy Safely ğŸš€ğŸš€
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          # Download and install the Koyeb CLI
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sh
          export PATH=$HOME/.koyeb/bin:$PATH
          
          echo "ğŸ“‹ Available organizations:"
          koyeb organizations list
          
          # Deploy Backend
          echo ""
          echo "ğŸ¢ === BACKEND DEPLOYMENT ==="
          echo "ğŸ”„ Switching to skillswap-back-bdd organization..."
          
          if koyeb organizations switch --organization skillswap-back-bdd; then
            echo "âœ… Successfully switched to skillswap-back-bdd"
          
            echo "ğŸ“‹ Available services:"
            koyeb services list
          
            echo "ğŸš€ Deploying backend service..."
            if koyeb services redeploy back/skillswap-api; then
              echo "âœ… Backend deployment completed"
            else
              echo "âŒ Backend deployment failed"
              echo "Available services in this organization:"
              koyeb services list --output table
            fi
          else
            echo "âŒ Failed to switch to skillswap-back-bdd organization"
          fi
          
          # Deploy Frontend
          echo ""
          echo "ğŸ¨ === FRONTEND DEPLOYMENT ==="
          echo "ğŸ”„ Switching to skillswap-front organization..."
          
          if koyeb organizations switch --organization skillswap-front; then
            echo "âœ… Successfully switched to skillswap-front"
          
            echo "ğŸ“‹ Available services:"
            koyeb services list
          
            echo "ğŸš€ Deploying frontend service..."
            if koyeb services redeploy front/skillswap-frontend; then
              echo "âœ… Frontend deployment completed"
            else
              echo "âŒ Frontend deployment failed"
              echo "Available services in this organization:"
              koyeb services list --output table
            fi
          else
            echo "âŒ Failed to switch to skillswap-front organization"
          fi
          
          echo ""
          echo "ğŸ‰ Deployment process completed!"