name: Deploy SkillSwap API to Koyeb (Safe Switch) 🚀
on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install Koyeb CLI and Deploy Safely 🚀🚀
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          # Download and install the Koyeb CLI
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sh
          export PATH=$HOME/.koyeb/bin:$PATH
          
          echo "📋 Available organizations:"
          koyeb organizations list
          
          # Deploy Backend
          echo ""
          echo "🏢 === BACKEND DEPLOYMENT ==="
          echo "🔄 Switching to skillswap-back-bdd organization..."
          
          if koyeb organizations switch --organization skillswap-back-bdd; then
            echo "✅ Successfully switched to skillswap-back-bdd"
          
            echo "📋 Available services:"
            koyeb services list
          
            echo "🚀 Deploying backend service..."
            if koyeb services redeploy back/skillswap-api; then
              echo "✅ Backend deployment completed"
            else
              echo "❌ Backend deployment failed"
              echo "Available services in this organization:"
              koyeb services list --output table
            fi
          else
            echo "❌ Failed to switch to skillswap-back-bdd organization"
          fi
          
          # Deploy Frontend
          echo ""
          echo "🎨 === FRONTEND DEPLOYMENT ==="
          echo "🔄 Switching to skillswap-front organization..."
          
          if koyeb organizations switch --organization skillswap-front; then
            echo "✅ Successfully switched to skillswap-front"
          
            echo "📋 Available services:"
            koyeb services list
          
            echo "🚀 Deploying frontend service..."
            if koyeb services redeploy front/skillswap-frontend; then
              echo "✅ Frontend deployment completed"
            else
              echo "❌ Frontend deployment failed"
              echo "Available services in this organization:"
              koyeb services list --output table
            fi
          else
            echo "❌ Failed to switch to skillswap-front organization"
          fi
          
          echo ""
          echo "🎉 Deployment process completed!"